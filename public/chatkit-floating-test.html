<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>ChatKit Floating Test</title>
    <style>
      body {
        margin: 0;
        font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Segoe UI Emoji", "Apple Color Emoji", "Noto Color Emoji";
        background: #f8fafc;
        color: #0f172a;
        min-height: 100vh;
      }
      .content {
        max-width: 720px;
        margin: 40px auto;
        padding: 0 16px;
      }
      h1 {
        margin: 0 0 8px;
        font-size: 1.25rem;
      }
      p {
        margin: 0 0 16px;
        color: #475569;
      }
      /* Bottom-right floating container for the chat widget */
      #chat-wrapper {
        position: fixed;
        bottom: 20px;
        right: 20px;
        width: 470px;  /* desktop size */
        height: 821px; /* desktop size */
        z-index: 10000;
        display: none;
        display: none;
        /* Layout so footer can sit below the widget */
        display: none;
      }
      #chat-wrapper.open { display: block; }

      /* Make wrapper a column container when open */
      #chat-wrapper.open { display: flex; flex-direction: column; }

      /* Top-right launcher link */
      #chat-launcher {
        position: fixed;
        top: 14px;
        right: 18px;
        background: transparent;
        color: #0f172a;
        font-weight: 700;
        text-decoration: underline;
        cursor: pointer;
        z-index: 10002;
      }
      #chat-wrapper > openai-chatkit {
        flex: 1 1 auto;
        width: 100%;
        height: auto;
        background: #ffffff;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 10px 30px rgba(2, 6, 23, 0.18);
      }

      /* Prefill footer sits below the widget inside wrapper */
      #chat-prefill-footer {
        margin-top: 0;
        background: #ffffff;
        border-radius: 10px;
        border-top-left-radius: 0; /* flush with widget above */
        border-top-right-radius: 0; /* flush with widget above */
        border: 1px solid #e2e8f0; /* slate-200 */
        border-top: none; /* remove seam */
        padding: 6px; /* p-1.5 */
      }
      #chat-prefill-footer .prefill-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        width: 100%;
        gap: 12px;
        padding: 8px 12px;
        border-radius: 8px;
        background: #ffffff;
        border: 1px solid transparent;
        color: #0f172a;
        cursor: pointer;
      }
      #chat-prefill-footer .prefill-item:hover { background: #f1f5f9; }
      #chat-prefill-footer .prefill-left { display: flex; align-items: center; gap: 12px; min-width: 0; }
      #chat-prefill-footer .prefill-icon {
        width: 24px; height: 24px; display: inline-flex; align-items: center; justify-content: center;
        border-radius: 9999px; background: #f1f5f9; color: #0f172a;
      }
      #chat-prefill-footer .prefill-label { font-size: 14px; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
      #chat-prefill-footer .prefill-disclaimer { text-align: center; font-size: 12px; color: #64748b; margin-top: 6px; }
      #chat-prefill-footer .prefill-disclaimer a { color: inherit; text-decoration: underline; }
      /* No native prompts; custom prefill footer below composer */

      /* (minimize now uses native header rightAction, no overlay) */

      @media (max-width: 480px) {
        #chat-wrapper {
          width: calc((100vw - 24px) * 1.21);
          height: 73vh;
          left: 12px;
          right: 12px;
          bottom: 12px;
        }
        
      }
    </style>
    <!-- Load the ChatKit web component -->
    <script
      src="https://cdn.platform.openai.com/deployments/chatkit/chatkit.js"
      async
    ></script>
  </head>
  <body>
    <div class="content">
      <h1>ChatKit Floating Test</h1>
      <p>
        Make sure your server is running with <code>OPENAI_API_KEY</code>      </p>
    </div>

    <a id="chat-launcher" href="#" aria-controls="chat-wrapper" aria-expanded="false">Support</a>
    <div id="chat-wrapper"></div>

    <script>
      function getUrlParam(name) {
        const url = new URL(window.location.href);
        const v = url.searchParams.get(name);
        return v ? v.trim() : null;
      }

      async function getClientSecret(currentSecret) {
        // Always mint on our server; ChatKit may call this again to refresh.
        const response = await fetch('/api/create-session', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            // Pass optional user context to the agent via scope
            scope: {
              firstName: getUrlParam('firstName') || getUrlParam('first') || null,
              email: getUrlParam('email') || null
            }
          })
        });
        if (!response.ok) {
          const text = await response.text().catch(() => '');
          throw new Error('Failed to create ChatKit session: ' + (text || response.statusText));
        }
        const data = await response.json();
        if (!data || !data.client_secret) {
          throw new Error('Missing client_secret in response');
        }
        return data.client_secret;
      }

      // Wait until the custom element is defined, then create and initialize it.
      (async function initWhenReady() {
        if (!(window.customElements && window.customElements.get('openai-chatkit'))) {
          requestAnimationFrame(initWhenReady);
          return;
        }

        try {
          const wrapper = document.getElementById('chat-wrapper');
          const launcher = document.getElementById('chat-launcher');
          const el = document.createElement('openai-chatkit');
          // Provide a token fetcher; ChatKit will call this as needed.
          el.setOptions({
            api: { getClientSecret },
            theme: {
              color: {
                accent: { primary: '#4ccf96', level: 3 },
              }
            },
            header: {
              rightAction: {
                icon: 'collapse-small',
                onClick: () => {
                  wrapper.classList.remove('open');
                  launcher.setAttribute('aria-expanded', 'false');
                }
              }
            },
            startScreen: {
              greeting: 'How can I help you with fyi?',
              prompts: [
                { label: 'What can fyi do for me?', prompt: 'What can fyi do for me?', icon: 'sparkle' },
                { label: 'Tell me about the subscription plans', prompt: 'Tell me about the subscription plans', icon: 'circle-question' }
              ]
            },
            disclaimer: {
              text: 'AI can make mistakes — Always check [our Help articles ](https://support.fyi.app/)'
            },
            // Make source items clickable when they include a usable URL.
            entities: {
              onClick: (entity) => {
                let url = (entity.data && entity.data.url) || (typeof entity.title === 'string' && entity.title.match(/^https?:\/\//) ? entity.title : null);
                // Fallback: derive FYI support article link from filename-like titles
                if (!url && typeof entity.title === 'string') {
                  const t = entity.title.trim();
                  // Match: 4404600478605-Support-Requests-and-... .html
                  const m = t.match(/^(\d{6,})-([A-Za-z0-9\-]+)\.html$/);
                  if (m) {
                    url = `https://support.fyi.app/hc/en-us/articles/${m[1]}-${m[2]}.html`;
                  }
                }
                if (url) {
                  try { window.open(url, '_blank', 'noopener,noreferrer'); } catch (_) {}
                }
              }
            },
            widgets: {
              onAction: async (action) => {
                try {
                  if (action?.type === 'prefill' && action?.payload?.text) {
                    await el.setComposerValue({ text: String(action.payload.text) });
                    await el.focusComposer();
                    return;
                  }
                  const url = (action && (action.payload?.url || action.payload?.href)) || null;
                  if (url && /^https?:\/\//.test(String(url))) {
                    try { window.open(String(url), '_blank', 'noopener,noreferrer'); } catch (_) {}
                  }
                } catch (_) {}
              }
            }
          });
          wrapper.appendChild(el);

          // Prefill footer (under composer area)
          const footer = document.createElement('div');
          footer.id = 'chat-prefill-footer';
          const list = document.createElement('div');
          list.className = 'prefill-list';
          const prompts = [
            ['Enhancement request', 'I want to request this product enhancement: '],
            ['Report an issue', 'I want to report the following issue: '],
            ['I need help with…', 'I need help with: '],
          ];
          const iconSvgs = {
            sparkle: '<svg viewBox="0 0 20 20" width="16" height="16" fill="currentColor"><path d="M9.5 1.75a.75.75 0 0 1 1 0l1.8 1.64c.2.18.31.43.31.7 0 .27-.11.52-.31.7L10.5 6.43a.75.75 0 0 1-1 0L7.7 4.79a.98.98 0 0 1-.31-.7c0-.27.11-.52.31-.7L9.5 1.75zM3.2 9.2a.6.6 0 0 1 .8 0l1.28 1.16c.18.16.28.38.28.62s-.1.46-.28.62L4 12.76a.6.6 0 0 1-.8 0l-1.28-1.16A.86.86 0 0 1 1.64 11c0-.24.1-.46.28-.62L3.2 9.2zm13.6 0a.6.6 0 0 1 .8 0l1.28 1.16c.18.16.28.38.28.62s-.1.46-.28.62L17.6 12.76a.6.6 0 0 1-.8 0l-1.28-1.16a.86.86 0 0 1-.28-.62c0-.24.1-.46.28-.62L16.8 9.2zM8.5 8.75a1 1 0 0 1 3 0l.41 1.25c.14.44.5.8.94.94L14.1 11a1 1 0 0 1 0 2l-1.25.41a1.5 1.5 0 0 0-.94.94L11.5 15a1 1 0 0 1-3 0l-.41-1.25a1.5 1.5 0 0 0-.94-.94L5.9 13a1 1 0 0 1 0-2l1.25-.41c.44-.14.8-.5.94-.94L8.5 8.75z"/></svg>',
            bug: '<svg viewBox="0 0 20 20" width="16" height="16" fill="currentColor"><path d="M10 2a2 2 0 0 1 2 2v1h1a2 2 0 0 1 2 2v1h-2V7H7v1H5V7a2 2 0 0 1 2-2h1V4a2 2 0 0 1 2-2zM4 10h12v4a4 4 0 0 1-4 4H8a4 4 0 0 1-4-4v-4z"/></svg>',
            lifesaver: '<svg viewBox="0 0 20 20" width="16" height="16" fill="currentColor"><path d="M10 2a8 8 0 1 0 0 16 8 8 0 0 0 0-16zm0 3a5 5 0 1 1 0 10A5 5 0 0 1 10 5z"/></svg>'
          };
          const rightSvg = '<svg viewBox="0 0 20 20" width="16" height="16" fill="currentColor"><path d="M7.25 5.25a.75.75 0 0 1 1.06 0l4 4a.75.75 0 0 1 0 1.06l-4 4a.75.75 0 1 1-1.06-1.06L10.94 10 7.25 6.31a.75.75 0 0 1 0-1.06z"/></svg>';
          const icons = ['sparkle','bug','lifesaver'];
          prompts.forEach(([label, text], idx) => {
            const btn = document.createElement('button');
            btn.type = 'button';
            btn.className = 'prefill-item';
            btn.innerHTML = `<span class="prefill-left"><span class="prefill-icon">${iconSvgs[icons[idx] || 'sparkle']}</span><span class="prefill-label">${label}</span></span>${rightSvg}`;
            btn.addEventListener('click', async () => {
              try { await el.setComposerValue({ text }); await el.focusComposer(); } catch (_) {}
            });
            list.appendChild(btn);
          });
          footer.appendChild(list);
          // Disclaimer is shown by ChatKit; avoid duplicating it in the footer
          wrapper.appendChild(footer);

          // Using prefill-only behavior in the app. No custom overlay toolbar here.

          let initKickoffSent = false;
          function openChat() {
            wrapper.classList.add('open');
            launcher.setAttribute('aria-expanded', 'true');
            // Focus composer after opening
            setTimeout(() => {
              try { el.focusComposer(); } catch (_) {}
              // Kickoff: ask agent to show prefill options widget on first open
              if (!initKickoffSent) {
                initKickoffSent = true;
                (async () => { try { await el.sendCustomAction({ type: 'init' }); } catch (_) {} })();
              }
            }, 0);
          }

          function closeChat() {
            wrapper.classList.remove('open');
            launcher.setAttribute('aria-expanded', 'false');
          }

          // Launcher click toggles chat visibility
          launcher.addEventListener('click', (e) => {
            e.preventDefault();
            if (wrapper.classList.contains('open')) {
              closeChat();
            } else {
              openChat();
            }
          });

          // No prompt bar; nothing to bind here.

          // Expose for console testing
          window.chatkitOpen = openChat;
          window.chatkitClose = closeChat;
        } catch (e) {
          console.error('[chatkit-floating-test] init failed', e);
        }
      })();
    </script>
  </body>
  </html>


