<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>ChatKit Minimal Test</title>
    <style>
      body {
        margin: 0;
        font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Segoe UI Emoji", "Apple Color Emoji", "Noto Color Emoji";
        background: #f8fafc;
        color: #0f172a;
      }
      /* Floating wrapper bottom-right */
      #chat-wrapper {
        position: fixed;
        bottom: 20px;
        right: 20px;
        width: 460px;
        height: 720px;
        z-index: 10000;
        display: none;
      }
      #chat-wrapper.open { display: flex; flex-direction: column; bottom: 86px; }
      #chat-wrapper > openai-chatkit {
        flex: 1 1 auto;
        width: 100%;
        height: auto;
        background: #ffffff;
        border-radius: 12px;
        box-shadow: 0 10px 30px rgba(2, 6, 23, 0.18);
        overflow: hidden;
        font-size: 14px;
        line-height: 1.4;
        --user-message-text-color: #ffffff;
        --font-text-md-size: 0.9rem;
        --accent-color-primary-inverse: #ffffff;
        --font-heading-lg-size: 1.3rem;
      }
      #chat-wrapper > openai-chatkit[data-accent="3"] {
        --user-message-text-color: #ffffff;
      }
      /* Round launcher button */
      #chat-launcher {
        position: fixed;
        bottom: 22px;
        right: 22px;
        width: 56px;
        height: 56px;
        border-radius: 9999px;
        background: #0f172a;
        color: #ffffff;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        text-decoration: none;
        box-shadow: 0 8px 24px rgba(2, 6, 23, 0.2);
        z-index: 10001;
        cursor: pointer;
      }
      #chat-launcher:hover { filter: brightness(1.05); }
    </style>
    <script
      src="https://cdn.platform.openai.com/deployments/chatkit/chatkit.js"
      async
    ></script>
  </head>
  <body>
    <a id="chat-launcher" href="#" aria-controls="chat-wrapper" aria-expanded="false" title="Chat">
      <svg viewBox="0 0 24 24" width="26" height="26" fill="currentColor" aria-hidden="true"><path d="M12 3C6.477 3 2 6.91 2 11.727c0 2.34 1.17 4.45 3.04 5.967-.09 1.07-.5 2.34-1.44 3.41-.22.25-.06.65.27.64 1.71-.06 3.22-.94 4.2-1.62.06-.04.13-.08.2-.12 1.1.36 2.29.56 3.53.56 5.523 0 10-3.91 10-8.727C22 6.91 17.523 3 12 3z"/></svg>
    </a>
    <div id="chat-wrapper"></div>

    <script>
      function getCaseInsensitiveParam(...candidates) {
        const url = new URL(window.location.href);
        const params = url.searchParams;
        const keys = Array.from(params.keys());
        for (const cand of candidates) {
          const found = keys.find((k) => k.toLowerCase() === String(cand).toLowerCase());
          if (found) {
            const v = params.get(found);
            if (v) { return v.trim(); }
          }
        }
        return null;
      }

      async function getClientSecret(currentSecret) {
        const res = await fetch('/api/create-session', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({})
        });
        if (!res.ok) {
          const t = await res.text().catch(() => '');
          throw new Error('Failed to create ChatKit session: ' + (t || res.statusText));
        }
        const data = await res.json();
        try { window.appSessionId = data.app_session_id || null; } catch(_) {}
        if (!data || !data.client_secret) throw new Error('Missing client_secret in response');
        return data.client_secret;
      }

      (async function initWhenReady(){
        if (!(window.customElements && window.customElements.get('openai-chatkit'))) {
          requestAnimationFrame(initWhenReady);
          return;
        }
        try {
          const wrapper = document.getElementById('chat-wrapper');
          const launcher = document.getElementById('chat-launcher');
          const firstForGreeting = getCaseInsensitiveParam('firstname','first','firstName');
          const uiGreeting = firstForGreeting ? `Hi ${firstForGreeting}, how can I help?` : 'How can I help you today?';

          // Enhancement form
          const ENH_TEXT = 'I want to request this product enhancement: ';
          const form = document.createElement('div');
          form.id = 'enh-form';
          form.style.cssText = 'display:none; position:absolute; left:8px; right:8px; bottom:8px; z-index:100; background:#ffffff; border:1px solid #e2e8f0; border-radius:10px; padding:10px; box-shadow:0 6px 16px rgba(2,6,23,.15);';
          form.innerHTML = `
            <div style="font-weight:600; color:#0f172a; margin-bottom:6px;">Enhancement request</div>
            <div style="display:grid; gap:8px;">
              <label style="display:flex; flex-direction:column; gap:4px;">
                <span style="color:#475569;">Title</span>
                <input id="enh-title" placeholder="Short, descriptive title" style="border:1px solid #cbd5e1; border-radius:6px; padding:6px;" />
              </label>
              <label style="display:flex; flex-direction:column; gap:4px;">
                <span style="color:#475569;">Description</span>
                <textarea id="enh-desc" rows="4" placeholder="What problem does this solve?" style="border:1px solid #cbd5e1; border-radius:6px; padding:6px;"></textarea>
              </label>
              <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px;">
                <label style="display:flex; flex-direction:column; gap:4px;">
                  <span style="color:#475569;">Priority</span>
                  <select id="enh-priority" style="border:1px solid #cbd5e1; border-radius:6px; padding:6px;">
                    <option>Low</option>
                    <option selected>Medium</option>
                    <option>High</option>
                  </select>
                </label>
                <label style="display:flex; flex-direction:column; gap:4px;">
                  <span style="color:#475569;">Impact</span>
                  <input id="enh-impact" placeholder="Who is impacted?" style="border:1px solid #cbd5e1; border-radius:6px; padding:6px;" />
                </label>
              </div>
              <div style="display:flex; justify-content:flex-end; gap:8px;">
                <button id="enh-cancel" type="button" style="border:1px solid #cbd5e1; background:#fff; color:#0f172a; padding:6px 10px; border-radius:6px; cursor:pointer;">Cancel</button>
                <button id="enh-submit" type="button" style="background:#0f172a; color:#fff; padding:6px 10px; border:none; border-radius:6px; cursor:pointer;">Add to message</button>
              </div>
            </div>
          `;

          // Create ChatKit element dynamically (like floating test)
          const el = document.createElement('openai-chatkit');
          
          const showForm = () => { form.style.display = 'block'; };
          const hideForm = () => {
            form.style.display = 'none';
            try {
              document.getElementById('enh-title').value = '';
              document.getElementById('enh-desc').value = '';
              document.getElementById('enh-priority').value = 'Medium';
              document.getElementById('enh-impact').value = '';
            } catch(_){}
          };
          
          form.addEventListener('click', async (e) => {
            const t = e.target?.id || e.target?.closest?.('#enh-cancel, #enh-submit')?.id || '';
            if (t === 'enh-cancel') { hideForm(); return; }
            if (t === 'enh-submit') {
              try {
                const title = String(document.getElementById('enh-title')?.value || '').trim();
                const desc = String(document.getElementById('enh-desc')?.value || '').trim();
                const priority = String(document.getElementById('enh-priority')?.value || 'Medium');
                const impact = String(document.getElementById('enh-impact')?.value || '').trim();
                const lines = ['I want to request a product enhancement:'];
                if (title) lines.push(`Title: ${title}`);
                if (desc) lines.push(`Description: ${desc}`);
                if (priority) lines.push(`Priority: ${priority}`);
                if (impact) lines.push(`Impact: ${impact}`);
                const text = lines.join('\n');
                if (text) { await el.setComposerValue({ text }); await el.focusComposer(); }
              } catch(_) {}
              hideForm();
            }
          });

          el.setOptions({
            api: { getClientSecret },
            theme: {
              color: { accent: { primary: '#4ccf96', level: 3 } }
            },
            header: {
              rightAction: {
                icon: 'collapse-small',
                onClick: () => { closeChat(); }
              }
            },
            startScreen: {
              greeting: uiGreeting,
              prompts: [
                { label: "What's new with fyi?", prompt: "What's the latest with fyi?", icon: 'sparkle' },
                { label: 'Tell me about the subscription plans', prompt: 'Tell me about the subscription plans', icon: 'circle-question' },
                { label: 'Enhancement request', prompt: ENH_TEXT, icon: 'sparkle' },
                { label: 'Report an issue', prompt: 'I want to report the following issue: ', icon: 'bug' }
              ]
            },
            disclaimer: { text: 'AI can make mistakes â€” See [ Help articles ](https://support.fyi.app/)' },
            composer: {
              placeholder: 'Your message to the assistant...',
              attachments: { enabled: false }
            },
            widgets: {
              onAction: async (action) => {
                if (action?.type === 'prefill') {
                  const text = action.payload?.text || '';
                  // Enhancement -> show form
                  if (text.toLowerCase().startsWith('i want to request this product enhancement')) {
                    showForm();
                    return;
                  }
                  // Report issue -> prefill only
                  if (text) {
                    await el.setComposerValue({ text });
                    await el.focusComposer();
                  }
                }
              }
            }
          });

          wrapper.appendChild(el);
          wrapper.appendChild(form);

          // S3 Upload injection
          let injectS3Button;
          (function injectS3Upload(){
            const PROGRESS_HTML = `
              <div id="s3-progress" style="display:none; position:absolute; left:12px; right:12px; bottom:56px; z-index:101;">
                <div style="height:6px; background:#e5e7eb; border-radius:9999px; overflow:hidden;">
                  <div id="s3-bar" style="width:0%; height:6px; background:#4ccf96;"></div>
                </div>
                <div id="s3-text" style="font-size:12px; color:#64748b; margin-top:4px;">0%</div>
              </div>`;
            
            let attempts = 0;
            const inject = () => {
              attempts++;
              const root = el.shadowRoot;
              if (!root) {
                console.log('[S3] No shadowRoot, attempt:', attempts);
                if (attempts < 100) requestAnimationFrame(inject);
                return;
              }
              const composer = root.querySelector('[data-kind="composer"]');
              console.log('[S3] Attempt:', attempts, 'hasComposer:', !!composer, 'totalElements:', root.querySelectorAll('*').length);
              if (!composer) {
                if (attempts < 100) requestAnimationFrame(inject);
                return;
              }
              if (composer.querySelector('[data-fyi-plus]')) {
                console.log('[S3] Button already exists');
                return;
              }

              if (!document.getElementById('s3-progress')) {
                wrapper.insertAdjacentHTML('beforeend', PROGRESS_HTML);
              }

              if (composer.style.position === 'static' || !composer.style.position) {
                composer.style.position = 'relative';
              }

              let input = document.getElementById('fyi-file');
              if (!input) {
                input = document.createElement('input');
                input.type = 'file';
                input.id = 'fyi-file';
                input.accept = 'image/*,application/pdf';
                input.style.display = 'none';
                wrapper.appendChild(input);
              }

              const plus = document.createElement('button');
              plus.setAttribute('data-fyi-plus', '1');
              plus.type = 'button';
              plus.title = 'Attach file';
              plus.textContent = '+';
              plus.style.cssText = 'position:absolute; right:8px; bottom:8px; width:32px; height:32px; border-radius:9999px; border:1px solid #cbd5e1; background:#4ccf96; color:#0f172a; font-weight:700; line-height:1; display:inline-flex; align-items:center; justify-content:center; cursor:pointer; z-index:999;';
              composer.appendChild(plus);
              console.log('[S3] Upload button injected successfully!');

              plus.addEventListener('click', () => input?.click());
              input.addEventListener('change', async (e) => {
                const f = e.target?.files?.[0];
                if (!f) return;
                const appSessionId = window.appSessionId;
                if (!appSessionId) { alert('Upload unavailable'); return; }
                
                const progress = document.getElementById('s3-progress');
                const bar = document.getElementById('s3-bar');
                const text = document.getElementById('s3-text');
                if (progress) progress.style.display = 'block';

                try {
                  const presignRes = await fetch('/api/attachments/presign', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ appSessionId, filename: f.name, mime: f.type || 'application/octet-stream', size: f.size })
                  });
                  const presign = await presignRes.json();
                  if (!presignRes.ok) throw new Error(presign?.error || 'presign failed');

                  await new Promise((resolve, reject) => {
                    const xhr = new XMLHttpRequest();
                    xhr.open('PUT', presign.url, true);
                    xhr.setRequestHeader('Content-Type', f.type || 'application/octet-stream');
                    xhr.setRequestHeader('x-amz-server-side-encryption', 'AES256');
                    xhr.upload.onprogress = (ev) => {
                      if (ev.lengthComputable && bar && text) {
                        const pct = Math.round((ev.loaded / ev.total) * 100);
                        bar.style.width = pct + '%';
                        text.textContent = pct + '%';
                      }
                    };
                    xhr.onload = () => xhr.status >= 200 && xhr.status < 300 ? resolve() : reject(new Error('Upload failed: ' + xhr.status));
                    xhr.onerror = () => reject(new Error('Network error'));
                    xhr.send(f);
                  });

                  if (progress) progress.style.display = 'none';
                  if (el.sendCustomAction) {
                    await el.sendCustomAction({ type: 'upload', payload: { name: f.name, key: presign.key } });
                  }
                  e.target.value = '';
                } catch (err) {
                  if (progress) progress.style.display = 'none';
                  alert('Upload failed: ' + (err?.message || err));
                }
              });
            };
            injectS3Button = inject;
            requestAnimationFrame(inject);
          })();

          // Force white user text
          (function forceWhiteText(){
            const apply = () => {
              const root = el.shadowRoot;
              if (!root) { requestAnimationFrame(apply); return; }
              if (root.querySelector('style[data-fyi-white]')) return;
              const style = document.createElement('style');
              style.setAttribute('data-fyi-white', '1');
              style.textContent = `
                [data-message-role="user"],
                [data-role="user"] {
                  --user-message-text-color: #ffffff !important;
                  color: #ffffff !important;
                }
                [data-message-role="user"] *,
                [data-role="user"] * {
                  color: #ffffff !important;
                }
              `;
              root.appendChild(style);
            };
            requestAnimationFrame(apply);
          })();

          // Hide internal header
          (function hideHeader(){
            const hide = () => {
              const root = el.shadowRoot;
              if (!root) { requestAnimationFrame(hide); return; }
              const headers = root.querySelectorAll('[part*="header"], [data-kind="header"], header');
              headers.forEach((h) => {
                Array.from(h.children).forEach((c) => {
                  const isAction = (c.getAttribute('part') || '').includes('rightAction') || c.getAttribute('aria-label');
                  if (!isAction) c.style.display = 'none';
                });
                h.style.background = 'transparent';
                h.style.border = 'none';
              });
            };
            requestAnimationFrame(hide);
          })();

          // Prevent native uploads
          el.addEventListener('drop', (ev) => { ev.preventDefault(); ev.stopPropagation(); }, true);
          el.addEventListener('paste', (ev) => {
            const items = ev.clipboardData?.items ? Array.from(ev.clipboardData.items) : [];
            if (items.some((it) => it?.kind === 'file')) {
              ev.preventDefault();
              ev.stopPropagation();
            }
          }, true);

          // Hide native attach button
          (function hideNativeAttach(){
            const hide = () => {
              const root = el.shadowRoot;
              if (!root) { requestAnimationFrame(hide); return; }
              if (root.querySelector('style[data-fyi-hide]')) return;
              const s = document.createElement('style');
              s.setAttribute('data-fyi-hide', '1');
              s.textContent = `[data-kind="composer"] [aria-label*="Attach" i], [data-kind="composer"] [part*="attach" i] { display: none !important; }`;
              root.appendChild(s);
            };
            requestAnimationFrame(hide);
          })();

          function openChat() {
            wrapper.classList.add('open');
            launcher.setAttribute('aria-expanded', 'true');
            // Trigger injection after opening (ChatKit renders composer when visible)
            setTimeout(() => {
              for (let i = 0; i < 20; i++) {
                setTimeout(() => { if (injectS3Button) injectS3Button(); }, i * 50);
              }
              try { el.focusComposer(); } catch(_){}
            }, 100);
          }

          function closeChat() {
            wrapper.classList.remove('open');
            launcher.setAttribute('aria-expanded', 'false');
          }

          launcher.addEventListener('click', (e) => {
            e.preventDefault();
            wrapper.classList.contains('open') ? closeChat() : openChat();
          });

        } catch (e) {
          console.error('[minimal-test] init failed', e);
        }
      })();
    </script>
  </body>
</html>
